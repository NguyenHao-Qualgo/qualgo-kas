# /etc/ganesha/ganesha.conf
# NFS Ganesha configuration for HITL (Hardware-in-the-Loop) development

LOG {
  Default_Log_Level = EVENT;
}

NFS_Core_Param {
  NFS_Port = 12049;
  Enable_RQUOTA = false;
  Enable_UDP = false;
  Protocols = 4;
  Bind_addr = 0.0.0.0;
  # Allow running in containers where PR_SET_IO_FLUSHER capability is not available
  allow_set_io_flusher_fail = true;
}

NFSV4 {
  Graceless = false;
  Allow_Numeric_Owners = true;
  Only_Numeric_Owners = true;
  # Disable delegations to ensure clients always check with server
  # This helps prevent stale data when files are updated on the host
  Delegations = false;
}

# MDCACHE configuration for HITL cache coherence
# Use_Getattr_Directory_Invalidation causes Ganesha to check if directory
# mtime has changed on disk during readdir operations, invalidating cache
# when files are updated by ext build
MDCACHE {
  Use_Getattr_Directory_Invalidation = true;
}

# Defaults that all EXPORT{} blocks inherit unless they override
EXPORT_DEFAULTS {
  Access_Type = RW;
  Squash = No_Root_Squash;
  Transports = TCP;
  Protocols = 4;
  SecType = none;
  Disable_ACL = true;
  Manage_Gids = false;
  Anonymous_uid = 0;
  Anonymous_gid = 0;
  # Short attribute expiration time for HITL development workflow
  # This ensures clients see updated files quickly after host rebuilds
  Attr_Expiration_Time = 5;
  # Disable delegations at export level as well
  Delegations = None;

  CLIENT {
    Clients = *;
    Access_Type = RO;
  }
}